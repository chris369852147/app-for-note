<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
 <link href="css/bootstrap.css" rel="stylesheet">
 <link rel="stylesheet" href="css/style.css">
 <script type="text/javascript" src="js/jquery-1.12.2.min.js"></script>
 <script type="text/javascript" src="js/bootstrap.min.js"></script>
	<title>Chris's own</title>
</head>
<body>
 <li type="button" class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">使用<span class ="caret"></span></a>
  <ul class="dropdown-menu">
      <li><a data-toggle="modal" data-target="#exampleModal">新增一筆交易</a></li>
      <li><a data-toggle="modal" data-target="#find">查詢特定範圍的交易或分析交易比例</a></li>
  </ul>
 </li>
 <button type="button" class="btn btn-warning" onclick="location.reload()">重新載入</button>
 <div class="modal fade" id="mymodal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="data-name"></h4>
      </div>
      <div class="modal-body" id="data">
        <p>One fine body&hellip;</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default all-button" data-dismiss="modal">關閉</button><br>
        <button type="button" class="btn btn-primary all-button" id="Change">變更交易內容</button>
      </div>
     </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
   </div><!-- /.modal -->
 <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">交易內容</h4>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="recipient-name" class="control-label">日期/時間:</label>
            <input type="datetime-local" class="form-control" id="date">
          </div>
          <div class="form-group">
            <label for="recipient-name" class="control-label">項目:</label>
            <input type="text" class="form-control" id="subject">
          </div>
          <div class="form-group">
            <label for="recipient-name" class="control-label">金額:</label>
            <input type="text" class="form-control" id="price">
          </div>
          <div class="form-group">
           <label for="recipient-name" class="control-label">付款方式:</label>
           <input class="pay" type="radio" name="pay" value="現金">現金
           <input class="pay" type="radio" name="pay" value="信用卡">信用卡
           <input class="pay" type="radio" name="pay" value="支票">支票
           <input class="pay" type="radio" name="pay" value="轉帳">轉帳
           <input class="pay" type="radio" name="pay" value="儲值卡">儲值卡
           <input class="pay" type="radio" name="pay" value="電子錢包">電子錢包
          </div>
          <div class="form-group">
            <label for="recipient-name" class="control-label">地點:</label>
            <input type="text" class="form-control" id="place">
          </div>
          <div class="form-group">
            <label for="recipient-name" class="control-label">交易對象:</label>
            <input type="text" class="form-control" id="person">
          </div>
          <div class="form-group">
           <select id="teachers">
            <option>選擇類別</option>
            <option>食品/保健</option>
            <option>服飾/內塑衣/鞋包</option>
            <option>娛樂</option>
            <option>婦幼</option>
            <option>3C/家電</option>
            <option>精品/配飾/美妝</option>
            <option>日用品</option>
            <option>家具/寢飾</option>
            <option>書籍/教育</option>
            <option>運動休閒用品</option>
            <option>交通</option>
            <option>股票/基金/投資</option>
	    <option>房仲/汽機車</option>
            <option>納稅</option>
            <option>武器/軍事</option>
            <option>其它</option>
           </select>
          </div>
          <div class="form-group">
            <label for="messbirthday-text" class="control-label">備註:</label>
            <textarea class="form-control" id="birthday" placeholder="無"></textarea>
          </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default all-button" data-dismiss="modal">取消</button><br>
        <button type="button" class="btn btn-primary all-button" id="save">新增</button>
      </div>
    </div>
  </div>
 </div>
 <div class="modal fade" id="set" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
   <div class="modal-content">
    <div class="modal-header">
     <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <h4 class="modal-title" id="exampleModalLabel">變更交易內容</h4>
     </div>
    <div class="modal-body">
      <form>
        <div class="form-group">
         <label for="recipient-name" class="control-label">日期/時間:</label>
         <input type="datetime-local" class="form-control" id="new-date">
        </div>
        <div class="form-group">
         <label for="recipient-name" class="control-label">項目:</label>
         <input type="text" class="form-control" id="new-subject">
        </div>
        <div class="form-group">
         <label for="recipient-name" class="control-label">金額:</label>
         <input type="text" class="form-control" id="new-price">
        </div>
        <div class="form-group">
           <label for="recipient-name" class="control-label">付款方式:</label>
           <input class="new-pay" type="radio" name="new-pay" value="現金">現金
           <input class="new-pay" type="radio" name="new-pay" value="信用卡">信用卡
           <input class="new-pay" type="radio" name="new-pay" value="支票">支票
           <input class="new-pay" type="radio" name="new-pay" value="轉帳">轉帳
           <input class="new-pay" type="radio" name="new-pay" value="儲值卡">儲值卡
           <input class="new-pay" type="radio" name="new-pay" value="電子錢包">電子錢包
        </div>
        <div class="form-group">
         <label for="recipient-name" class="control-label">地點:</label>
         <input type="text" class="form-control" id="new-place">
        </div>
        <div class="form-group">
         <label for="recipient-name" class="control-label">交易對象:</label>
         <input type="text" class="form-control" id="new-person">
        </div>
        <div class="form-group">
         <select id="new-teachers">
          <option>選擇類別</option>
          <option>食品/保健</option>
          <option>服飾/內塑衣/鞋包</option>
          <option>娛樂</option>
          <option>婦幼</option>
          <option>3C/家電</option>
          <option>精品/配飾/美妝</option>
          <option>日用品</option>
          <option>家具/寢飾</option>
          <option>書籍/教育</option>
          <option>運動休閒用品</option>
          <option>交通</option>
          <option>股票/基金/投資</option>
	  <option>房仲/汽機車</option>
          <option>納稅</option>
          <option>武器/軍事</option>
          <option>其它</option>
         </select>
        </div>
        <div class="form-group">
         <label for="recipient-name" class="control-label">備註:</label>
         <textarea class="form-control" id="new-birthday"></textarea>
        </div>
       </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default all-button" data-dismiss="modal">取消</button><br>
        <button type="button" class="btn btn-warning all-button" id="Delete">刪除交易內容</button><br>
        <button type="button" class="btn btn-primary all-button" id="changedata">儲存變更</button>
      </div>
   </div>
  </div>
 </div>
 <div class="modal fade" id="find" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">查詢/分析範圍</h4>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <input id="gte" type="datetime-local" class="form-control">
            <p>~</p>
            <input id="lte" type="datetime-local" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default all-button" data-dismiss="modal">取消</button><br>
        <button type="button" class="btn btn-success all-button" id="search">查詢</button><br>
        <button type="button" class="btn btn-primary all-button" id="analysis">分析</button>
      </div>
      <div>
       <table class="table table-striped">
        <thead>
         <tr>
          <th>類別</th>
          <th>次數</th>
          <th>總金額</th>
          <th>金額比例</th>
          <th>次數比例</th>
         </tr>
        </thead>
        <tbody id="result">
        </tbody>
       </table>
      </div>
    </div>
  </div>
 </div>
<table class="table table-striped">
 <thead>
  <tr>
   <th>日期</th>
   <th>項目</th>
  </tr>
 </thead>
 <tbody id="dollars">
 </tbody>
</table>
<script type="text/javascript" src="js/fdb-all.min.js"></script>
<script type="text/javascript">
var tr;
var fdb = new ForerunnerDB();
var db = fdb.db("mymoney");
var dollarCollection = db.collection('dollars');
dollarCollection.load();
function showModal(){
 tr = $(this)
 var aaa=$(this).attr('data-id')
 var dollar=dollarCollection.find({
   _id:aaa
 })[0];
 console.log(dollar);
 $("#data-name").text("關於"+dollar.subject);
 $("#data").html("金額:"+dollar.price+"<br>"+"付款方式:"+dollar.pay+"<br>"+"地點:"+dollar.place+"<br>"+"交易對象:"+dollar.person+"<br>"+"類別:"+dollar.teacher+"<br>"+"備註:"+dollar.you);
 $("#mymodal").modal("show");
}
$("#dollars").on("click","tr",showModal);
setTimeout(function(){
 var dollars =dollarCollection.find();
 for (var i = 0; i < dollars.length; i++) {
 	var _id = dollars[i]._id;
	var date = dollars[i].date;
	var subject = dollars[i].subject;
   	$("#dollars").prepend(createString(_id,date,subject));
   	};
},500);
$("#save").click(function(){
	var pay=$('input[name=pay]:checked').val();
    var aaaa={
 	  date:$("#date").val(),
 	  subject:$("#subject").val(),
 	  price:$("#price").val(),
 	  pay:pay,
 	  place:$("#place").val(),
 	  person:$("#person").val(),
 	  teacher:$("#teachers").val(),
 	  you:$("#birthday").val()
 };
 $("#date").val("");
 $("#subject").val("");
 $("#price").val("");
 $(".pay").removeAttr('checked');
 $("#place").val("");
 $("#person").val("");
 $("#teachers").val("選擇類別");
 $("#birthday").val("");
 dollarCollection.insert(aaaa);
 dollarCollection.save();
 $("#exampleModal").modal('hide');
 var aaa=dollarCollection.find(aaaa)[0];
 $("#dollars").prepend(createString(aaa._id,aaa.date,aaa.subject));
 });
function createString(_id,date,subject){
	return "<tr data-id='"+_id+"'><td>"+date+"</td><td>"+subject+"</td></tr>"
};
function c(teacher,time,price,proportionprice,proportiontime) {
	return "<tr><td>"+teacher+"</td><td>"+time+"</td><td>"+price+"</td><td>"+proportionprice+"</td><td>"+proportiontime+"</td></tr>"
};
$("#Change").click(function(){
  var aaa=$(tr).attr('data-id')
  console.log(aaa)
  var dollar=dollarCollection.find({
  	_id:aaa
  })[0];
	$("#set").modal('show');
	$("#new-date").val(dollar.date);
	$("#new-subject").val(dollar.subject);
 	$("#new-price").val(dollar.price);
 	$("#new-place").val(dollar.place);
 	$("#new-person").val(dollar.person);
	$("#new-teachers").val(dollar.teacher);
	$("#new-birthday").val(dollar.you);
});
$("#Delete").click(function(){
    var aaa=$(tr).attr('data-id')
	dollarCollection.remove({
		_id:aaa
	});
 dollarCollection.save();
 $("#mymodal").modal('hide');
 tr.remove();
 $("#set").modal('hide');
});
$("#changedata").click(function(){
	var pay=$('input[name=new-pay]:checked').val();
	var aaa=$(tr).attr('data-id');
    dollarCollection.updateById(
 	aaa
  ,{
 	  date:$("#new-date").val(),
 	  subject:$("#new-subject").val(),
 	  price:$("#new-price").val(),
 	  pay:pay,
 	  place:$("#new-place").val(),
 	  person:$("#new-person").val(),
 	  teacher:$("#new-teachers").val(),
 	  you:$("#new-birthday").val()
 	    
 });
    console.log($("#new-subject").val())
    $("#new-date").val("");
    $("#new-subject").val("");
    $("#new-price").val("");
    $(".new-pay").removeAttr('checked');
    $("#new-place").val("");
    $("#new-person").val("");
    $("#new-teachers").val("選擇類別");
    $("#new-birthday").val("");
	dollarCollection.save();
	$("#set").modal('hide');
	$("#mymodal").modal('hide');
});
$("#search").click(function(){
	var dollars=dollarCollection.find({
		date:{
			$gte:$("#gte").val(),
			$lte:$("#lte").val()
		}
	},{
		$orderBy:{date:1}
	});
	console.log(dollars);
	$("#dollars tr").remove();
	for (var i = 0; i < dollars.length; i++) {
 	   var _id = dollars[i]._id
	   var date = dollars[i].date;
	   var subject = dollars[i].subject;
   	   $("#dollars").prepend(createString(_id,date,subject));
   	};
   	$("#gte").val("");
   	$("#lte").val("");
   	$("#find").modal('hide');
});
$("#analysis").click(function(){
	var dollars=dollarCollection.find({
		date:{
			$gte:$("#gte").val(),
			$lte:$("#lte").val()
		}
	},{
		$orderBy:{date:1}
	});
	console.log(dollars);
	$("#result tr").remove();
	var sum=[0,0,0,0,0,0,0,0,0,0,0,0,0,0]
	var times=[0,0,0,0,0,0,0,0,0,0,0,0,0,0]
	var teachers=["食品/保健","服飾/內塑衣/鞋包","娛樂","婦幼","3C/家電","精品/配飾/美妝","日用品","家具/寢飾","書籍/教育","運動休閒用品","交通","股票/基金/投資","武器/軍事","其它"]
	for (var i = 0; i < dollars.length; i++) {
		for (var j = 0; j < teachers.length; j++) {
			if (dollars[i].teacher==teachers[j]) {
				sum[j]+=dollars[i].price/1;
				times[j]+=1;
			}
		}
   	}
   	var totalprices=0;
   	for (var i = 0; i < sum.length; i++) {
   		totalprices+=sum[i];
   	}
   	var totaltimes=0;
   	for (var i = 0; i < times.length; i++) {
   		totaltimes+=times[i];
   	}
   	var proportionprices=[0,0,0,0,0,0,0,0,0,0,0,0,0,0];
   	for (var i = 0; i < sum.length; i++) {
   		proportionprices[i]=Math.round(sum[i]/totalprices*100);
   	}
   	var proportiontimes=[0,0,0,0,0,0,0,0,0,0,0,0,0,0];
   	for (var i = 0; i < times.length; i++) {
   		proportiontimes[i]=Math.round(times[i]/totaltimes*100);
   	}
   	for (var i = 0; i < teachers.length; i++) {
 	   var teacher = teachers[i];
	   var time = times[i];
	   var price = sum[i];
	   var proportionprice=proportionprices[i];
	   var proportiontime=proportiontimes[i];
   	   $("#result").append(c(teacher,time,price,proportionprice,proportiontime));
   	};
});
</script>
</body>
</html>
